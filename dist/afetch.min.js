/*! afetch.js v1.0.0 | MIT License | https://github.com/naveedurrehman/afetch */
(function(global){const lower=e=>(e||"").toLowerCase(),strictJSON=e=>e?JSON.parse(e):null,resolveFn=e=>e?e.split(".").reduce(((e,t)=>e?e[t]:void 0),globalThis):null,callHook=(e,t,r)=>{const o=e.getAttribute(t);if(!o)return;let a;try{a=resolveFn(o),a=new Function("detail",`"use strict"; return ((${o}))(detail);`)}catch(e){return void console.error(`Invalid inline handler in ${t}: ${o}`,e)}if("function"==typeof a)try{return a(r)}catch(e){console.error(`Error running ${t}`,e)}};function appendJsonToFormData(e,t,r){null!=t&&(t instanceof File||t instanceof Blob?e.append(r||"file",t):"object"!=typeof t?r&&e.append(r,String(t)):Array.isArray(t)?t.forEach(((t,o)=>appendJsonToFormData(e,t,r?`${r}[${o}]`:String(o)))):Object.entries(t).forEach((([t,o])=>appendJsonToFormData(e,o,r?`${r}[${t}]`:t))))}const buildFormDataFromForms=e=>{const t=new FormData;return e.forEach((e=>{const r=document.getElementById(e);if(!r)return void console.warn(`fetch-forms: form not found: ${e}`);const o=new FormData(r);for(const[e,r]of o.entries())t.append(e,r)})),t},parseByType=async(e,t)=>{const r=(e.headers.get("content-type")||"").toLowerCase(),o=lower(t||"auto");return"json"===o?{kind:"json",data:await e.json()}:"text"===o?{kind:"text",data:await e.text()}:"blob"===o?{kind:"blob",data:await e.blob()}:r.includes("application/json")?{kind:"json",data:await e.json()}:r.includes("application/javascript")||r.includes("text/javascript")?{kind:"js",data:await e.text()}:r.startsWith("text/")||r.includes("charset=")?{kind:"text",data:await e.text()}:{kind:"blob",data:await e.blob()}},buildBodyHeaders=(e,t)=>{const r=e.getAttribute("fetch-forms");if(r){const o=r.split(/\s*,\s*/).filter(Boolean),a=buildFormDataFromForms(o);if(e.hasAttribute("fetch-body"))try{const t=strictJSON(e.getAttribute("fetch-body"));t&&appendJsonToFormData(a,t)}catch(t){console.error("fetch-body merge failed:",t),callHook(e,"fetch-onerror",{element:e,error:t})}const n=new Headers;return["get","head"].includes(lower(t))?(console.warn("fetch-forms with GET/HEAD â€” switching to POST"),{headers:n,body:a,queryObj:null,methodOverride:"POST"}):{headers:n,body:a,queryObj:null}}const o=new Headers,a=e.getAttribute("fetch-headers");if(a){const e=strictJSON(a);if(e&&"object"==typeof e)for(const[t,r]of Object.entries(e))o.set(t,r)}const n=e.hasAttribute("fetch-body")?strictJSON(e.getAttribute("fetch-body")):null;if(["get","head"].includes(lower(t)))return{headers:o,body:void 0,queryObj:n};if(n&&"object"==typeof n){if("application/x-www-form-urlencoded"===(o.get("Content-Type")||"").toLowerCase()){const e=new URLSearchParams;for(const[t,r]of Object.entries(n))e.append(t,String(r));return{headers:o,body:e.toString(),queryObj:null}}return o.has("Content-Type")||o.set("Content-Type","application/json"),{headers:o,body:JSON.stringify(n),queryObj:null}}return{headers:o,body:void 0,queryObj:null}};async function handleClick(e){const a=e.target.closest("a[fetch], button[fetch]");if(!a)return;e.preventDefault(),a.hasAttribute("fetch-onbefore")&&callHook(a,"fetch-onbefore",a);const urlAttr=a.getAttribute("fetch");if(!urlAttr)return;let method=a.getAttribute("fetch-method")||"GET";const mode=a.getAttribute("fetch-mode")||void 0,credentials=a.getAttribute("fetch-credentials")||void 0,cache=a.getAttribute("fetch-cache")||void 0,redirect=a.getAttribute("fetch-redirect")||void 0,referrer=a.getAttribute("fetch-referrer")||void 0,refPol=a.getAttribute("fetch-referrer-policy")||void 0,responseAs=a.getAttribute("fetch-response")||"auto",targetSel=a.getAttribute("fetch-target")||null,targetformat=a.getAttribute("fetch-target-format")||"html",targetmode=a.getAttribute("fetch-target-mode")||0,timeoutMs=parseInt(a.getAttribute("fetch-timeout")||"0",10)||0,execjs=getBooleanAttr(a,"fetch-execjs",!0);let url=new URL(urlAttr,location.href),body,headers,queryObj,methodOverride;try{({body:body,headers:headers,queryObj:queryObj,methodOverride:methodOverride}=buildBodyHeaders(a,method)),methodOverride&&(method=methodOverride)}catch(e){if(console.error(["fetch-onfetchbodyerror",e]),callHook(a,"fetch-onfetchbodyerror",{element:a,error:e}),callHook(a,"fetch-onerror",{element:a,error:e}),targetSel){const t=document.querySelector(targetSel);t&&renderToTarget(t,`Invalid fetch-body: ${e.message}`,targetformat,targetmode)}return}queryObj&&Object.entries(queryObj).forEach((([e,t])=>url.searchParams.set(e,String(t))));const controller=new AbortController,timeoutId=timeoutMs?setTimeout((()=>{controller.abort("Timeout!"),console.error(["fetch-ontimeout"]),callHook(a,"fetch-ontimeout",{element:a,url:url.href,method:method,timeout:timeoutMs})}),timeoutMs):null;activateSpinner(a,!0),activateDisabling(a,!0),callHook(a,"fetch-onstart",{element:a,url:url.href,method:method,init:{headers:headers instanceof Headers?Object.fromEntries(headers.entries()):headers,body:body}});const wasDisabled=a.hasAttribute("aria-disabled");a.setAttribute("aria-disabled","true");try{const res=await fetch(url,{method:method,headers:headers,body:body,mode:mode,credentials:credentials,cache:cache,redirect:redirect,referrer:referrer,referrerPolicy:refPol,signal:controller.signal});if(callHook(a,"fetch-onresponse",{element:a,url:url.href,method:method,response:res}),!res.ok){const e=await parseByType(res,responseAs);if(console.error(["fetch-onfailure",e]),callHook(a,"fetch-onfailure",{element:a,url:url.href,method:method,error:e}),callHook(a,"fetch-onerror",{element:a,error:e}),targetSel){const t=document.querySelector(targetSel);t&&renderToTarget(t,"json"===e.kind?JSON.stringify(e.data,null,2):"text"===e.kind||"js"===e.kind?e.data:"[blob received]",targetformat,targetmode)}return}const resClone=res.clone();let parsed;try{parsed=await parseByType(res,responseAs)}catch(e){let t="";try{t=await resClone.text()}catch{}if(console.error(["fetch-onparsingerror",e]),callHook(a,"fetch-onparsingerror",{element:a,url:url.href,method:method,error:e,raw:t,response:res}),callHook(a,"fetch-onerror",{element:a,error:e}),targetSel){const r=document.querySelector(targetSel);r&&renderToTarget(r,t||String(e),targetformat,targetmode)}return}if("json"===parsed.kind&&callHook(a,"fetch-onjson",{element:a,url:url.href,method:method,data:parsed.data,response:res}),"text"===parsed.kind&&callHook(a,"fetch-ontext",{element:a,url:url.href,method:method,data:parsed.data,response:res}),"blob"===parsed.kind&&callHook(a,"fetch-onblob",{element:a,url:url.href,method:method,data:parsed.data,response:res}),"js"===parsed.kind&&(callHook(a,"fetch-onjs",{element:a,url:url.href,method:method,data:parsed.data,response:res}),!0===execjs&&eval(parsed.data)),targetSel){const e=document.querySelector(targetSel);e&&renderToTarget(e,"json"===parsed.kind?JSON.stringify(parsed.data,null,2):"text"===parsed.kind||"js"===parsed.kind?parsed.data:"[blob received]",targetformat,targetmode)}}catch(e){console.error(["fetch-onfailure",e]),callHook(a,"fetch-onfailure",{element:a,url:url.href,method:method,error:e}),callHook(a,"fetch-onerror",{element:a,error:e})}finally{timeoutId&&clearTimeout(timeoutId),wasDisabled||a.removeAttribute("aria-disabled"),activateSpinner(a,!1),activateDisabling(a,!1),callHook(a,"fetch-oncomplete",{element:a,url:url.href,method:method})}}function getBooleanAttr(e,t,r=!1){if(!e.hasAttribute(t))return r;const o=e.getAttribute(t);if(null==o||""===o)return!0;const a=String(o).trim().toLowerCase();return!!["true","1","yes","y","on"].includes(a)||!["false","0","no","n","off"].includes(a)&&r}function renderToTarget(e,t,r="html",o="reset"){if(!e)return e;const a="html"===String(r).toLowerCase(),n=null==o||0===o||"reset"===String(o).toLowerCase()?0:1===o||"append"===String(o).toLowerCase()?1:-1===o||"prepend"===String(o).toLowerCase()?-1:0,i=null==t?"":String(t);return 0===n?a?e.innerHTML=i:e.textContent=i:1===n?a?e.insertAdjacentHTML("beforeend",i):e.insertAdjacentText("beforeend",i):a?e.insertAdjacentHTML("afterbegin",i):e.insertAdjacentText("afterbegin",i),e}function activateSpinner(e,t){e.hasAttribute("fetch-spinner")&&document.querySelectorAll(e.getAttribute("fetch-spinner")).forEach((e=>{e.style.display=1==t?"":"none"}))}function activateDisabling(e,t){e.hasAttribute("fetch-disabling")&&(e.disabled=t)}function upgradeAnchors(e=document){e.querySelectorAll("a[fetch]:not([data-afetch]), button[fetch]:not([data-afetch])").forEach((e=>{e.setAttribute("data-afetch",""),"a"===e.localName&&(e.hasAttribute("role")||e.setAttribute("role","button"),e.hasAttribute("tabindex")||e.setAttribute("tabindex","0"),e.hasAttribute("href")||e.setAttribute("href","#")),e.hasAttribute("fetch-spinner")&&activateSpinner(e,!1)}))}function init(){if(global.__afetch_click_bound||(document.addEventListener("click",handleClick),document.addEventListener("keydown",(e=>{if("Enter"===e.key||" "===e.key){const t=e.target.closest("a[fetch], button[fetch]");t&&(e.preventDefault(),t.click())}})),global.__afetch_click_bound=!0),upgradeAnchors(document),!global.__afetch_observer&&!global.AFetch?.disableAutoObserve){const e=new MutationObserver((e=>{for(const t of e)"childList"===t.type&&t.addedNodes.forEach((e=>{1===e.nodeType&&(e.matches?.("a[fetch], button[fetch]")?upgradeAnchors(e.parentNode||document):upgradeAnchors(e))}))}));e.observe(document.documentElement,{childList:!0,subtree:!0}),global.__afetch_observer=e}}global.AFetch=Object.assign(global.AFetch||{},{init:init,refresh:()=>upgradeAnchors(document),disableAutoObserve:!1}),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init()})(window);